# Модернизированный [Sonoff-Tasmota](https://github.com/arendst/Sonoff-Tasmota)
текущий номер релиза Sonoff-Tasmota 6.2.1.5 20180921
Прошивка обновляется по мере наличия свободного времени.

Для облегчения поддержки вносятся минимальные изменения в оригинальные файлы и добавляются новые.

Необходимость данного форка вызвана тем, что для автоматизации дома на базе **OpenHub** потребовалось изменить некоторые модули и написать новые модули для поддержки новых устройств.
* увеличено количество датчиков DS18B20
* сокращены поля вывода MQTT, т.к. не хватало длины MQTT сообщения
* добавлена поддержка нескольких ADS1115 (для автоматизации требуется 16 ЦАП - обработка обратной связи с приводов воздушных заслонок)
* добавлена поддержка расширителя портов MCP23017 (в последней версии _**Sonoff-Tasmota**_) появилась поддержка. надо разбиратся.
* добавлена поддержка PCA9685
---
* (надо добавить конвертер MODBUS RTU - MQTT для Danfoss FC51)
* (надо добавить конвертер MODBUS RTU - MQTT для счетчика Меркурий 231)

---

## Основные изменения к **Sonoff-Tasmota**

**Список файлов и причина их изменения:**

* ***patformio. ini*** - по умолчанию установлена плата   LVA, настроен ком.порт, выключены лишние модули. 

* ***sanoff/i18n.h***  	- сокращен вывод сообщений MQTT

* ***sanoff/xdrv_interface.ino***  (был добавлен дебуг вызова модуля)

*  ***sanoff/xsns_12_ads1115_ada.ino***	- переделан вывод строк.
* ***sanoff/sonoff.ino*** - добавлен DEBUG для MQTT сообщений подключается _lva_post.h_, файлом _lva_post.h_ уточняем  последними определения (если чего-то надо переопределить)

* ***user_config.h***  не все  можно выключить ***user_config_override.h***, по этому правим user_config.h

  ***user_config_override.h*** 	- мои переопределение define по умолчанию. здесь надо указать вариант моей компановки. включаем стандарную компановку tasmota USE_CLASSIC

* ***sanoff/xdrv_interface.ino*** -добавлен DEBUG на сериал при  выполнении функции _XdrvCommand_
* ***sanoff/xsns_05_ds18x20_legacy.ino*** - увеличено количество датчиков до 24 (нахрена если их всего у меня максимум 16), сокращен вывод информации на webpage. (_надо довести до ума, бросил_.)
* ***sanoff/xsns_12_ads1115.ino*** - стандартная библиотека передаланаая на сокращенный вывод. только один девайс поддерживает.
* ***sanoff/xsns_12_ads1115_lva.ino*** - собственная библиотека поддержки 4 устройств, надо проверять на совместимость с последней версией Тамоты.
* ***sanoff/xsns_91mcp_lva.ino*** - собственная библиотека, ранее в Тамоте не было поддержки MCP23017, сейчас появилась(***xsns_29_mcp230xx.ino***), возможно надо убирать.

* ***sanoff/lva_post.h*** -  здесь отключаем все лишнее из USE_CLASSIC, и делаем свои компоновки.



___
  как правило в измененных оригинальных файлах  в пятой строке добавлен текст **UPDATED LVA**
  изменения в тексте обрамлены строками:

  // LVA <--
>#ifndef \_LVA
>#else
>#endif
//  LVA  -->


### В весенне-летний период занимался стройкой дома не поддерживал проект, много воды утекло за это время. много чего появилось.

попробую актализировать проект с версии (	5.12.0a) и понять, что изменилось в _**Sonoff-Tasmota**_ и провести синхронизаию с данным проектом.


1. новая версия _**Sonoff-Tasmota**_ научилась пуллить какое то устройство по сериалу на скорости 9600, возможно это rs-485 надо разобраться (xsns_17_senseair.ino)


2. добавились функции вызова модулей файл xdrv_interface.ino

 * Function call to all xdrv
 *
 * FUNC_PRE_INIT
 * FUNC_INIT
 * FUNC_LOOP
 * FUNC_MQTT_SUBSCRIBE
 * FUNC_MQTT_INIT
 * return FUNC_MQTT_DATA
 * return FUNC_COMMAND
 * FUNC_SET_POWER
 * FUNC_SHOW_SENSOR
 * FUNC_EVERY_SECOND
 * FUNC_EVERY_50_MSECOND
 * FUNC_EVERY_100_MSECOND
 * FUNC_EVERY_250_MSECOND
 * FUNC_RULES_PROCESS
 * FUNC_FREE_MEM

4.разбираем как работает _**Sonoff-Tasmota**_ (шпаргалка, чтобы запомнить)
4.1 - сначала обрабатывается _sonoff.ino_, где включается _user_config.h_ и т.д.

4.2 название модулей 
 * xdrv_ - драйвера
 * xdsp_ - модули для работы с дисплеями
 * xnrg_ - модули для работы с сенсорами мощности
 * xsns  - модули для работы с прочими сенсорами

#MODBUS
 **xsns_23_ sdm120 .ino** - Eastron SDM120 -Modbus-измеритель мощности. по умолчанию включено фарианте сборки **sensors**. поддерка фключается в **sonoff_post.h**
функция SDM120250ms опрашивает устройство и читает 8 адрессов попорядку, приетом в функции сначала проверяется чтение, а только потом посылается запрос устройству. только чтение и публикация 8 параметров.

**xnrg_05_pzem2.ino** - PZEM-003,017 и PZEM-014,016 Поддержка датчика энергопотребления Modbus
**xsns_17_senseair.ino** - Поддержка датчика CO2 SenseAir K30, K70 и S8 
все эти датчики не плохой вариант считывать меркурий 230, думаю должна быть очень похожие таблицы.


5. [Правила оформления файла README.MD на GITHUB](http://webdesign.ru.net/article/pravila-oformleniya-fayla-readmemd-na-github.html)




7. Сейчас рабает два модуля ESP (WEMOS d1 mini V2) 
Камин  (Датчики теспературы (5 шт.) подулючены к D4 )
отопление  (Датчики теспературы (11 шт) подулючены к D4 ) модуль ополения постоянно висит, горит светодиод GPIO2 (D4) или он всетаки на ТХ (GPI01)пине?

надо сделать по принципу оригинала: разные ключи под прошивки для разных устройств:

* камин (температурные датчики 5 шт, электрический счетчик отопления)
* отопление (температурны датчики, расширительн портов для контроля напряжений, управления АВР дизеля)
* Меркурий (для счетчика на столбе)
* чердак (данфосы, de-icing, температурные датчики, управление приводами вентиляции)


99. Шпаргалки
* Как найти в файлах всей папки -  сочетание клавиш Shift + Ctrl + F. Замена во всех файлах проекта также делается.


BE_MINIMAL + user_config_overgrive

DATA:    [======    ]  58.5% (used 47952 bytes from 81920 bytes)
PROGRAM: [===       ]  33.2% (used 347915 bytes from 1048576 bytes)

+ выключили USE_KNX_WEB_MENU
