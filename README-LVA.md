# Модернизированный [Sonoff-Tasmota](https://github.com/arendst/Sonoff-Tasmota)

Прошивка обновляется по мере наличия свободного времени.

Для облегчения поддержки вносятся минимальные изменения в оригинальные файлы и добавляются новые.

Необходимость данного форка вызвана тем, что для автоматизации дома на базе **OpenHub** потребовалось изменить некоторые модули и написать новые модули для поддержки новых устройств.
* увеличено количество датчиков DS18B20
* сокращены поля вывода MQTT, т.к. не хватало длины MQTT сообщения
* добавлена поддержка нескольких ADS1115 (для автоматизации требуется 16 ЦАП - обработка обратной связи с приводов воздушных заслонок)
* добавлена поддержка расширителя портов MCP23017 (в последней версии _**Sonoff-Tasmota**_) появилась поддержка. надо разбиратся.
* добавлена поддержка PCA9685
---
* (надо добавить конвертер MODBUS RTU - MQTT для Danfoss FC51)
* (надо добавить конвертер MODBUS RTU - MQTT для счетчика Меркурий 231)

---

## Основные изменения к **Sonoff-Tasmota**

**Список файлов и причина их изменения:**

* ***patformio. ini*** - по умолчанию установлена плата   LVA, настроен ком.порт, выключены лишние модули.

* ***sanoff/i18n.h***  	- сокращен вывод сообщений MQTT
  ***lva.h*** 					- переопределение определений по умолчанию.
* ***sanoff/sonoff_post.h*** 			- подключается  ***lva.h***

* ***sanoff/xdrv_interface.ino***  (был добавлен дебуг вызова модуля)

*  ***sanoff/xsns_12_ads1115_ada.ino***	- переделан вывод строк.
* ***sanoff/sonoff.ino*** - добавлен DEBUG для MQTT сообщений.
* ***sanoff/sonoff_post.h*** - добавлена загрузка ***lva.h*** возможно это не надо.
* ***sanoff/xdrv_interface.ino*** -добавлен DEBUG на сериал при  выполнении функции _XdrvCommand_
* ***sanoff/xsns_05_ds18x20_legacy.ino*** - увеличено количество датчиков до 24 (нахрена если их всего у меня максимум 16), сокращен вывод информации на webpage. (_надо довести до ума, бросил_.)
* ***sanoff/xsns_12_ads1115.ino*** - стандартная библиотека передаланаая на сокращенный вывод. только один девайс поддерживает.
* ***sanoff/xsns_12_ads1115_lva.ino*** - собственная библиотека поддержки 4 устройств, надо проверять на совместимость с последней версией Тамоты.
* ***sanoff/xsns_91mcp_lva.ino*** - собственная библиотека, ранее в Тамоте не было поддержки MCP23017, сейчас появилась(***xsns_29_mcp230xx.ino***), возможно надо убирать.

* ***sanoff/sonoff_post.h*** - файлом _lva_post.h_ уточняем  последними определения (если чего-то надо переопределить)
___
  как правило в измененных оригинальных файлах  в пятой строке добавлен текст **UPDATED LVA**
  изменения в тексте обрамлены строками:

  // LVA <--
>#ifndef \_LVA
>#else
>#endif
//  LVA  -->


### В весенне-летний период занимался стройкой дома не поддерживал проект, много воды утекло за это время. много чего появилось.

попробую актализировать проект и понять, что изменилось в _**Sonoff-Tasmota**_ и провести синхронизаию с данным проектом.


1. новая версия _**Sonoff-Tasmota**_ научилась пуллить какое то устройство по сериалу на скорости 9600, возможно это rs-485 надо разобраться (xsns_17_senseair.ino)


2. добавились функции вызова модулей файл xdrv_interface.ino

 * Function call to all xdrv
 *
 * FUNC_PRE_INIT
 * FUNC_INIT
 * FUNC_LOOP
 * FUNC_MQTT_SUBSCRIBE
 * FUNC_MQTT_INIT
 * return FUNC_MQTT_DATA
 * return FUNC_COMMAND
 * FUNC_SET_POWER
 * FUNC_SHOW_SENSOR
 * FUNC_EVERY_SECOND
 * FUNC_EVERY_50_MSECOND
 * FUNC_EVERY_100_MSECOND
 * FUNC_EVERY_250_MSECOND
 * FUNC_RULES_PROCESS
 * FUNC_FREE_MEM

4.разбираем как работает _**Sonoff-Tasmota**_ (шпаргалка, чтобы запомнить)
4.1 - сначала обрабатывается _sonoff.ino_, где включается _user_config.h_ и т.д.


5. [Правила оформления файла README.MD на GITHUB](http://webdesign.ru.net/article/pravila-oformleniya-fayla-readmemd-na-github.html)

6. Как найти в файлах всей папки
Делается через сочетание клавиш Shift + Ctrl + F. Замена во всех файлах проекта также делается.
